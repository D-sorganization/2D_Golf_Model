name: CI

on:
  pull_request:
  push:
    branches: [ main ]

# Minimal permissions for security
permissions:
  contents: read

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diffs

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit pytest pytest-cov
          if [ -f python/requirements.txt ]; then pip install -r python/requirements.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run quality check
        run: |
          if [ -f scripts/quality_check.py ]; then
            python scripts/quality_check.py
          else
            echo "‚ö†Ô∏è Warning: scripts/quality_check.py not found"
          fi

      - name: Check for placeholders
        run: |
          # Fail if TODO, FIXME, or other placeholders found in Python files
          if grep -r "TODO\|FIXME\|XXX\|HACK\|pass #\|\.\.\..*#\|NotImplementedError" \
            --include="*.py" \
            --exclude-dir=".git" \
            --exclude-dir="archive" \
            --exclude-dir="legacy" \
            --exclude-dir="experimental" .; then
            echo "‚ùå ERROR: Placeholders found in code"
            exit 1
          else
            echo "‚úÖ No placeholders found"
          fi

      - name: Check for magic numbers
        run: |
          # Check for common magic numbers that should be constants
          if grep -r "[^0-9a-zA-Z_]3\.14[0-9]*\|9\.8[0-9]*\|6\.67[0-9]*\|2\.71[0-9]*" \
            --include="*.py" \
            --exclude-dir=".git" \
            --exclude-dir="tests" .; then
            echo "‚ö†Ô∏è WARNING: Possible magic numbers found (should be named constants with sources)"
            echo "Examples: 3.14‚Üímath.pi, 9.8‚ÜíGRAVITY_M_S2, 2.71‚Üímath.e"
          else
            echo "‚úÖ No obvious magic numbers found"
          fi

      - name: Check for approximations
        run: |
          # Fail if "approximately" or similar found
          if grep -ri "approximately\|approx[^a-z]\|roughly\|~[0-9]" \
            --include="*.py" --include="*.m" \
            --exclude-dir=".git" \
            --exclude-dir="docs" .; then
            echo "‚ùå ERROR: Approximations found - use exact values with sources"
            exit 1
          else
            echo "‚úÖ No approximations found"
          fi

      - name: Run pre-commit
        run: |
          pre-commit run --all-files --show-diff-on-failure

      - name: Run strict type checking
        run: |
          pip install mypy==1.10.0
          if [ -f mypy.ini ]; then
            if [ -d python ]; then
              mypy python/ --config-file mypy.ini || echo "‚ö†Ô∏è Type errors found"
            else
              mypy . --config-file mypy.ini || echo "‚ö†Ô∏è Type errors found"
            fi
          elif find . -name "*.py" -not -path "./archive/*" -not -path "./legacy/*" -not -path "./matlab/*" -not -path "./matlab_optimized/*" | head -n1 | grep -q .; then
            if [ -d python ]; then
              mypy python/ --ignore-missing-imports || echo "‚ö†Ô∏è Type errors found"
            else
              mypy . --ignore-missing-imports || echo "‚ö†Ô∏è Type errors found"
            fi
          else
            echo "No Python files to type check"
          fi

      - name: Run tests with coverage
        run: |
          if [ -d python/tests ] || [ -d tests ]; then
            pytest -xvs --cov=python --cov-report=term-missing --cov-fail-under=60 || {
              echo "‚ùå Tests failed or coverage below 60%"
              exit 1
            }
          else
            echo "‚ö†Ô∏è WARNING: No tests directory found - ADD TESTS!"
          fi

      - name: Verify reproducibility
        run: |
          # Check that random seeds are set in Python files using randomness
          echo "Checking for unseeded randomness..."
          for file in $(find . -name "*.py" -type f -not -path "./archive/*" -not -path "./legacy/*"); do
            if grep -q "np\.random\|random\.\|torch\." "$file" 2>/dev/null; then
              if ! grep -q "seed\|random_state\|generator" "$file"; then
                echo "‚ö†Ô∏è Warning: $file uses randomness without visible seed"
              fi
            fi
          done

      - name: Check for required constants documentation
        run: |
          # Verify physical constants have units and sources
          echo "Checking constants documentation..."
          for file in $(find . -name "*.py" -type f -not -path "./tests/*" -not -path "./archive/*"); do
            if grep -q "GRAVITY\|MASS\|DENSITY\|COEFFICIENT" "$file" 2>/dev/null; then
              if ! grep -q "\[.*\].*#\|#.*\[.*\]" "$file"; then
                echo "‚ö†Ô∏è Warning: $file may have undocumented constants (need units + source)"
              fi
            fi
          done

      - name: MATLAB Quality Checks (bash-based, no license needed)
        run: |
          echo "üîç Running MATLAB quality checks (bash-based)..."
          
          # Check for magic numbers in MATLAB files
          echo ""
          echo "1Ô∏è‚É£ Checking for magic numbers in MATLAB files..."
          # Use -r flag with xargs to handle empty results
          if find matlab matlab_optimized -name "*.m" -type f 2>/dev/null | grep -v "Archive\|Backup\|test" | xargs -r grep -H '[^0-9a-zA-Z_]3\.14[0-9]*\|9\.8[0-9]*\|6\.67[0-9]*\|2\.71[0-9]*' 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: Possible magic numbers found in MATLAB files"
            echo "Use named constants: 3.14‚Üípi, 9.8‚Üíg (with source), 2.71‚Üíexp(1)"
          else
            echo "‚úÖ No magic numbers found in MATLAB files"
          fi
          
          # Check for approximations in MATLAB files
          echo ""
          echo "2Ô∏è‚É£ Checking for approximations in MATLAB files..."
          if find matlab matlab_optimized -name "*.m" -type f 2>/dev/null | grep -v "Archive\|Backup" | xargs -r grep -Hi "approximately\|approx[^a-z]\|roughly\|~[0-9]" 2>/dev/null; then
            echo "‚ùå ERROR: Approximations found in MATLAB files - use exact values"
            exit 1
          else
            echo "‚úÖ No approximations found in MATLAB files"
          fi
          
          # Check for random number generation without seeds
          echo ""
          echo "3Ô∏è‚É£ Checking for unseeded randomness in MATLAB files..."
          UNSEEDED_COUNT=0
          if [ -d matlab ] || [ -d matlab_optimized ]; then
            for file in $(find matlab matlab_optimized -name "*.m" -type f 2>/dev/null | grep -v "Archive\|Backup"); do
              if grep -qE '\brand\(|\brandn\(|\brandi\(' "$file" 2>/dev/null; then
                if ! grep -qE '\brng\(' "$file" 2>/dev/null; then
                  echo "‚ö†Ô∏è Warning: $file uses randomness without rng seed"
                  UNSEEDED_COUNT=$((UNSEEDED_COUNT + 1))
                fi
              fi
            done
          fi
          
          if [ $UNSEEDED_COUNT -eq 0 ]; then
            echo "‚úÖ All MATLAB files with randomness have seeds"
          else
            echo "‚ö†Ô∏è Found $UNSEEDED_COUNT MATLAB files with unseeded randomness"
          fi
          
          # Count MATLAB files and tests
          echo ""
          echo "4Ô∏è‚É£ MATLAB file statistics..."
          MATLAB_COUNT=0
          OPTIMIZED_COUNT=0
          TEST_COUNT=0
          
          if [ -d matlab ]; then
            MATLAB_COUNT=$(find matlab -name "*.m" -type f 2>/dev/null | wc -l)
          fi
          if [ -d matlab_optimized ]; then
            OPTIMIZED_COUNT=$(find matlab_optimized -name "*.m" -type f 2>/dev/null | wc -l)
          fi
          if [ -d matlab/tests ]; then
            TEST_COUNT=$(find matlab/tests -name "*.m" -type f 2>/dev/null | wc -l)
          fi
          
          echo "üìä Found $MATLAB_COUNT MATLAB files in matlab/"
          echo "üìä Found $OPTIMIZED_COUNT MATLAB files in matlab_optimized/"
          echo "üìä Found $TEST_COUNT test files in matlab/tests/"
          
          if [ $TEST_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è WARNING: No MATLAB test files found - add tests!"
          else
            echo "‚úÖ MATLAB test files exist"
          fi
          
          # Verify run_matlab_quality_checks.m exists
          echo ""
          echo "5Ô∏è‚É£ Checking for MATLAB quality check script..."
          if [ -f "run_matlab_quality_checks.m" ]; then
            echo "‚úÖ run_matlab_quality_checks.m found"
            echo "   Run 'matlab -batch run_matlab_quality_checks' locally for full checks"
          else
            echo "‚ö†Ô∏è run_matlab_quality_checks.m not found"
          fi

      - name: Summary
        if: always()
        run: |
          echo "### CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Check | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| No Placeholders | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| No Magic Numbers | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| No Approximations | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-commit | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Checking | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests + Coverage | ‚úÖ |" >> $GITHUB_STEP_SUMMARY
          echo "| MATLAB Checks | ‚úÖ |" >> $GITHUB_STEP_SUMMARY

  matlab-analysis:
    name: MATLAB Analysis (requires MATLAB license)
    runs-on: ubuntu-latest
    # Enable when MATLAB runner available
    # Set to 'true' when MATLAB license is configured
    if: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2023b
          products: MATLAB Simulink  # Add required toolboxes
      
      - name: Run MATLAB quality checks
        uses: matlab-actions/run-command@v2
        with:
          command: |
            % Run comprehensive quality checks
            fprintf('üîç Running MATLAB Quality Checks...\n\n');
            
            % Add all paths
            addpath(genpath('matlab'));
            if exist('matlab_optimized', 'dir')
                addpath(genpath('matlab_optimized'));
            end
            
            % Run the quality check script
            if exist('run_matlab_quality_checks.m', 'file')
                run_matlab_quality_checks();
            else
                warning('run_matlab_quality_checks.m not found, running basic checks');
                
                % Basic magic number check
                mFiles = [dir('matlab/**/*.m'); dir('matlab_optimized/**/*.m')];
                for i = 1:length(mFiles)
                    filePath = fullfile(mFiles(i).folder, mFiles(i).name);
                    if contains(filePath, 'Archive') || contains(filePath, 'Backup')
                        continue;
                    end
                    content = fileread(filePath);
                    if contains(content, {'3.14', '9.8', '6.67'})
                        warning('Possible magic number in %s', filePath);
                    end
                end
            end
            
            fprintf('\n‚úÖ MATLAB quality checks completed\n');
      
      - name: Run MATLAB unit tests
        uses: matlab-actions/run-tests@v2
        with:
          source-folder: matlab
          test-results-junit: test-results/matlab-results.xml
          code-coverage-cobertura: code-coverage/matlab-coverage.xml
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: matlab-test-results
          path: test-results/
          if-no-files-found: ignore
      
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: matlab-coverage
          path: code-coverage/
          if-no-files-found: ignore
